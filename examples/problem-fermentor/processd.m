function sys = processd(t,x,flag,u,p)

  sys = [];
  if flag == 1 % df/dx
      h1 = 0.11*(x(3)/(0.006*x(1)+x(3)));
      h2 = 0.0055*(x(3)/(0.0001+x(3)*(1+10*x(3))));
      dh1dx1 = -(33*x(3))/(50000*((3*x(1))/500 + x(3))^2);
      dh1dx3 = 11/(100*((3*x(1))/500 + x(3))) - (11*x(3))/(100*((3*x(1))/500 + x(3))^2);
      dh2dx3 = 11/(2000*(x(3)*(10*x(3) + 1) + 1/10000)) - (11*x(3)*(20*x(3) + 1))/(2000*(x(3)*(10*x(3) + 1) + 1/10000)^2);
      dx1dx1 = h1 + x(1)*dh1dx1 - u(1)/(500*x(4));
      dx1dx3 = x(1)*dh1dx3;
      dx1dx4 = (u(1)*x(1))/(500*x(4)^2);
      dx2dx1 = h2;
      dx2dx2 = - u(1)/(500*x(4)) - 0.01;
      dx2dx3 = x(1)*dh2dx3;
      dx2dx4 = (u(1)*x(2))/(500*x(4)^2);
      %      dx3dx1 =(33*x(1)*x(3))/(23500*((3*x(1))/500 + x(3))^2) - (11*x(3))/(2400*(x(3)*(10*x(3) + 1) + 1/10000)) - (11*x(3))/(47*((3*x(1))/500 + x(3))) - (29*x(3))/(1000*(x(3) + 1/10000));
      dx3dx1 = - (100*x(1)*dh1dx1)/47 - (100*h1)/47-(5*h2)/6-(29*x(3))/(1000*(x(3) + 1/10000));
      %      dx3dx3 = (11*x(1)*x(3))/(47*((3*x(1))/500 + x(3))^2) - (11*x(1))/(2400*(x(3)*(10*x(3) + 1) + 1/10000)) - u(1)/(500*x(4)) - (11*x(1))/(47*((3*x(1))/500 + x(3))) - (29*x(1))/(1000*(x(3) + 1/10000)) + (29*x(1)*x(3))/(1000*(x(3) + 1/10000)^2) + (11*x(1)*x(3)*(20*x(3) + 1))/(2400*(x(3)*(10*x(3) + 1) + 1/10000)^2);
      dx3dx3 = -(100*x(1)*dh1dx3)/47-(5*x(1)*dh2dx3)/6+(29*x(1)*x(3))/(1000*(x(3) + 1/10000)^2) - u/(500*x(4)) - (29*x(1))/(1000*(x(3) + 1/10000));
      dx3dx4 = (u(1)*(x(3)/500 - 1))/x(4)^2;
      sys = [dx1dx1 dx2dx1 dx3dx1 0
             0      dx2dx2 0      0
             dx1dx3 dx2dx3 dx3dx3 0
             dx1dx4 dx2dx4 dx3dx4 0];
  elseif flag == 2 % df/du
    sys = [-x(1)/(500*x(4)), -x(2)/(500*x(4)), -(x(3)/500-1)/x(4),  1/500];
  end
end
