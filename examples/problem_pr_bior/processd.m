function sys = processd(t,x,flag,u,p)

  sys = [];
  if flag == 1 % df/dx
      g(3) = 21.87*(x(4))/((x(4) + .4)*(x(4) + 62.5));
      g(1) = 4.75*(g(3))/(.12 + g(3));
      g(2) = (x(4))/(.1 + x(4))*exp(-5*x(4));
      dg3dx4 = 2187/(100*(x(4) + 2/5)*(x(4) + 125/2)) - (2187*x(4))/(100*(x(4) + 2/5)*(x(4) + 125/2)^2) - (2187*x(4))/(100*(x(4) + 2/5)^2*(x(4) + 125/2));
      dg2dx4 = exp(-5*x(4))/(x(4) + 1/10) - (5*x(4)*exp(-5*x(4)))/(x(4) + 1/10) - (x(4)*exp(-5*x(4)))/(x(4) + 1/10)^2;
      %      dg1dg3 = 19/(4*(gx3 + 3/25)) - (19*gx3)/(4*(gx3 + 3/25)^2)
      dg1dx4 = 41553/(400*((2187*x(4))/(100*(x(4) + 2/5)*(x(4) + 125/2)) + 3/25)*(x(4) + 2/5)*(x(4) + 125/2)) - (41553*x(4))/(400*((2187*x(4))/(100*(x(4) + 2/5)*(x(4) + 125/2)) + 3/25)*(x(4) + 2/5)*(x(4) + 125/2)^2) - (41553*x(4))/(400*((2187*x(4))/(100*(x(4) + 2/5)*(x(4) + 125/2)) + 3/25)*(x(4) + 2/5)^2*(x(4) + 125/2)) + (41553*x(4)*((2187*x(4))/(100*(x(4) + 2/5)*(x(4) + 125/2)^2) - 2187/(100*(x(4) + 2/5)*(x(4) + 125/2)) + (2187*x(4))/(100*(x(4) + 2/5)^2*(x(4) + 125/2))))/(400*((2187*x(4))/(100*(x(4) + 2/5)*(x(4) + 125/2)) + 3/25)^2*(x(4) + 2/5)*(x(4) + 125/2));
      df1dx1 = - g(1) - u/x(5); df1dx2 = g(1); df1dx4 = -(x(1) - x(2))*dg1dx4; df1dx5 = (u*x(1))/x(5)^2;
      df2dx1 = 0; df2dx2 = -u/x(5); df2dx3 = g(2); df2dx4 = x(3)*dg2dx4; df2dx5 = (u*x(2))/x(5)^2;
      df3dx3 = g(3) - u/x(5); df3dx4 = x(3)*dg3dx4; df3dx5 = (u*x(3))/x(5)^2;
      df4dx3 = -(73*g(3))/10; df4dx4=-(73*x(3)*dg3dx4)/10 - u/x(5); df4dx5 = (u*(x(4) - 20))/x(5)^2;
      sys = [df1dx1 df2dx1 0 0 0
             df1dx2 df2dx2 0 0 0
             0 df2dx3 df3dx3 df4dx3 0
             df1dx4 df2dx4 df3dx4 df4dx4 0
             df1dx5 df2dx5 df3dx5 df4dx5 0];
  elseif flag == 2 % df/du
    sys = [-x(1)/x(5), -x(2)/x(5), -x(3)/x(5), -(x(4)-20)/x(5), 1];
  end
end
